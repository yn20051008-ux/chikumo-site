<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>開発者記録 - 畜物語</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  
  <script>
    // Firebase設定（グローバル）
    const firebaseConfig = {
      apiKey: "AIzaSyBw5-6oAuOmgYC_7G27Z0Qavwn78ZrkhdQ",
      authDomain: "chikumonogatarikiroku.firebaseapp.com",
      databaseURL: "https://chikumonogatarikiroku-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "chikumonogatarikiroku",
      storageBucket: "chikumonogatarikiroku.firebasestorage.app",
      messagingSenderId: "725202431277",
      appId: "1:725202431277:web:c49c911cfcae26d63ab7a4"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <style>
    /* ━━━━━━━━━━━━━━━━━━━━━━
       BASE / RESET
    ━━━━━━━━━━━━━━━━━━━━━━ */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 16px;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", sans-serif;
      background: #000;
      color: #fff;
      min-height: 100dvh;
      overflow-x: hidden;
      line-height: 1.5;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       LAYOUT
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .container {
      max-width: 430px;
      margin: 0 auto;
      padding: 0 16px 32px;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       HEADER - 年月表示
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 20px 0 16px;
      position: relative;
    }

    .year-selector {
      position: relative;
      cursor: pointer;
    }

    .year-display {
      font-size: 17px;
      font-weight: 600;
      color: #ff3b30;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .year-display::after {
      content: '';
      width: 6px;
      height: 6px;
      border-right: 1.5px solid #ff3b30;
      border-bottom: 1.5px solid #ff3b30;
      transform: rotate(45deg);
      margin-top: -2px;
    }

    .month-display {
      font-size: 17px;
      font-weight: 600;
      color: #fff;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       年ホイールピッカー
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .year-picker-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .year-picker-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .year-picker {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1c1c1e;
      border-radius: 12px 12px 0 0;
      z-index: 101;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    }

    .year-picker-overlay.active .year-picker {
      transform: translateY(0);
    }

    .year-picker-header {
      display: flex;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid #38383a;
    }

    .year-picker-btn {
      background: none;
      border: none;
      color: #ff3b30;
      font-size: 17px;
      font-weight: 400;
      cursor: pointer;
    }

    .year-picker-btn.done {
      font-weight: 600;
    }

    .wheel-container {
      height: 216px;
      position: relative;
      overflow: hidden;
      -webkit-mask-image: linear-gradient(to bottom, transparent, black 30%, black 70%, transparent);
      mask-image: linear-gradient(to bottom, transparent, black 30%, black 70%, transparent);
    }

    .wheel {
      position: absolute;
      width: 100%;
      top: 50%;
      transform: translateY(-50%);
      transition: transform 0.1s ease-out;
    }

    .wheel-item {
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      color: #fff;
      opacity: 0.4;
      transition: opacity 0.2s, transform 0.2s;
    }

    .wheel-item.selected {
      opacity: 1;
      font-weight: 500;
    }

    .wheel-highlight {
      position: absolute;
      top: 50%;
      left: 16px;
      right: 16px;
      height: 36px;
      transform: translateY(-50%);
      border-top: 0.5px solid #48484a;
      border-bottom: 0.5px solid #48484a;
      pointer-events: none;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       WEEKDAY HEADER
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      padding: 8px 0;
      border-bottom: 0.5px solid #38383a;
    }

    .weekday {
      font-size: 11px;
      font-weight: 600;
      color: #8e8e93;
      text-transform: uppercase;
    }

    .weekday:first-child {
      color: #ff3b30;
    }

    .weekday:last-child {
      color: #007aff;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       CALENDAR GRID
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .calendar-wrapper {
      overflow: hidden;
      touch-action: pan-y;
    }

    .calendar-slider {
      display: flex;
      transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    }

    .calendar {
      flex: 0 0 100%;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px 0;
      padding: 8px 0;
    }

    .day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
      border-radius: 50%;
      transition: background 0.15s;
      position: relative;
    }

    .day:active {
      background: rgba(255, 255, 255, 0.1);
    }

    .day.other-month {
      opacity: 0.3;
    }

    .day-number {
      font-size: 16px;
      font-weight: 400;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .day.today .day-number {
      background: #ff3b30;
      color: #fff;
      font-weight: 500;
    }

    .day.selected:not(.today) .day-number {
      background: #48484a;
    }

    .day.sunday .day-number {
      color: #ff6961;
    }

    .day.saturday .day-number {
      color: #64d2ff;
    }

    .day.today.sunday .day-number,
    .day.today.saturday .day-number {
      color: #fff;
    }

    .day.holiday .day-number {
      color: #ff6961;
    }

    .day.today.holiday .day-number {
      color: #fff;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       TASK INDICATORS
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .indicator {
      height: 4px;
      border-radius: 2px;
      display: flex;
      gap: 1px;
      overflow: hidden;
    }

    /* 1件: ピンクドット */
    .indicator[data-count="1"] {
      width: 4px;
      background: #ff6b9d;
    }

    /* 2件: 短いバー（ピンク＋水色） */
    .indicator[data-count="2"] {
      width: 16px;
    }

    .indicator[data-count="2"]::before {
      content: '';
      flex: 1;
      background: #ff6b9d;
      border-radius: 2px 0 0 2px;
    }

    .indicator[data-count="2"]::after {
      content: '';
      flex: 1;
      background: #5ac8fa;
      border-radius: 0 2px 2px 0;
    }

    /* 3件: 長いバー（ピンク＋水色＋黄色） */
    .indicator[data-count="3"] {
      width: 24px;
    }

    .indicator[data-count="3"] .seg {
      flex: 1;
    }

    .indicator[data-count="3"] .seg:nth-child(1) {
      background: #ff6b9d;
      border-radius: 2px 0 0 2px;
    }

    .indicator[data-count="3"] .seg:nth-child(2) {
      background: #5ac8fa;
    }

    .indicator[data-count="3"] .seg:nth-child(3) {
      background: #ffd60a;
      border-radius: 0 2px 2px 0;
    }

    /* 4件以上: 長いバー（紫単色） */
    .indicator[data-count="4"] {
      width: 24px;
      background: #bf5af2;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       LOG SECTION
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .log-section {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 0.5px solid #38383a;
    }

    .log-date {
      font-size: 13px;
      color: #8e8e93;
      margin-bottom: 12px;
    }

    .log-list {
      list-style: none;
    }

    .log-item {
      padding: 12px 0;
      border-bottom: 0.5px solid #2c2c2e;
      font-size: 15px;
      color: #fff;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .log-item::before {
      content: '';
      width: 6px;
      height: 6px;
      background: #ff6b9d;
      border-radius: 50%;
      margin-top: 7px;
      flex-shrink: 0;
    }

    .log-item:nth-child(2)::before {
      background: #5ac8fa;
    }

    .log-item:nth-child(3)::before {
      background: #ffd60a;
    }

    .log-item:nth-child(n+4)::before {
      background: #bf5af2;
    }

    .log-empty {
      font-size: 15px;
      color: #636366;
      text-align: center;
      padding: 24px 0;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       EDIT MODE UI
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .edit-section {
      display: none;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 0.5px solid #38383a;
    }

    .edit-mode .edit-section {
      display: block;
    }

    .edit-input-wrapper {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .edit-input {
      flex: 1;
      background: #1c1c1e;
      border: none;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 15px;
      color: #fff;
      outline: none;
    }

    .edit-input::placeholder {
      color: #636366;
    }

    .edit-input:focus {
      box-shadow: 0 0 0 1px #ff3b30;
    }

    .btn {
      background: #ff3b30;
      border: none;
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .btn:active {
      opacity: 0.7;
    }

    .btn-delete {
      background: #48484a;
      width: 100%;
      margin-top: 8px;
    }

    .edit-log-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 0.5px solid #2c2c2e;
    }

    .edit-log-text {
      font-size: 15px;
      color: #fff;
      flex: 1;
    }

    .edit-log-delete {
      background: none;
      border: none;
      color: #ff453a;
      font-size: 14px;
      cursor: pointer;
      padding: 4px 8px;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       UTILITIES
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ═══════════════════════════════
         HEADER: 年・月表示
    ═══════════════════════════════ -->
    <header class="header">
      <div class="year-selector" id="yearSelector">
        <span class="year-display" id="yearDisplay">2026</span>
      </div>
      <span class="month-display" id="monthDisplay">1月</span>
    </header>

    <!-- ═══════════════════════════════
         曜日ヘッダー
    ═══════════════════════════════ -->
    <div class="weekdays">
      <span class="weekday">日</span>
      <span class="weekday">月</span>
      <span class="weekday">火</span>
      <span class="weekday">水</span>
      <span class="weekday">木</span>
      <span class="weekday">金</span>
      <span class="weekday">土</span>
    </div>

    <!-- ═══════════════════════════════
         カレンダーグリッド（スワイプ対応）
    ═══════════════════════════════ -->
    <div class="calendar-wrapper" id="calendarWrapper">
      <div class="calendar-slider" id="calendarSlider">
        <div class="calendar" id="prevCalendar"></div>
        <div class="calendar" id="currentCalendar"></div>
        <div class="calendar" id="nextCalendar"></div>
      </div>
    </div>

    <!-- ═══════════════════════════════
         選択日のログ表示
    ═══════════════════════════════ -->
    <section class="log-section">
      <p class="log-date" id="logDate"></p>
      <ul class="log-list" id="logList"></ul>
      <p class="log-empty hidden" id="logEmpty">記録はありません</p>
    </section>

    <!-- ═══════════════════════════════
         編集UI（?edit=true時のみ表示）
    ═══════════════════════════════ -->
    <section class="edit-section">
      <div class="edit-input-wrapper">
        <input type="text" class="edit-input" id="editInput" placeholder="作業内容を入力">
        <button class="btn" id="addBtn">追加</button>
      </div>
      <div id="editLogList"></div>
    </section>
  </div>

  <!-- ═══════════════════════════════
       年ピッカー（ホイールUI）
  ═══════════════════════════════ -->
  <div class="year-picker-overlay" id="yearPickerOverlay">
    <div class="year-picker">
      <div class="year-picker-header">
        <button class="year-picker-btn" id="yearCancelBtn">キャンセル</button>
        <button class="year-picker-btn done" id="yearDoneBtn">完了</button>
      </div>
      <div class="wheel-container" id="wheelContainer">
        <div class="wheel-highlight"></div>
        <div class="wheel" id="yearWheel"></div>
      </div>
    </div>
  </div>

  <script>
    /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
       開発者記録 - 畜物語プロジェクト
       Vanilla JavaScript 実装
    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

    document.addEventListener('DOMContentLoaded', function() {
      'use strict';

      // ═══════════════════════════════
      // Firebase参照
      // ═══════════════════════════════
      const database = firebase.database();
      const logsRef = database.ref('logs');

      // ═══════════════════════════════
      // 設定
      // ═══════════════════════════════
      const START_YEAR = 2026;
      const END_YEAR = 2035;

      // ═══════════════════════════════
      // 状態管理
      // ═══════════════════════════════
      let currentYear = new Date().getFullYear();
      let currentMonth = new Date().getMonth();
      let selectedDate = null;
      let logData = {};
      let isEditMode = new URLSearchParams(window.location.search).get('edit') === 'true';
      let tempSelectedYear = currentYear;

      // 開始年より前は開始年にセット
      if (currentYear < START_YEAR) {
        currentYear = START_YEAR;
        currentMonth = 0;
      }

      // ═══════════════════════════════
      // DOM要素
      // ═══════════════════════════════
      const $ = id => document.getElementById(id);
      const yearDisplay = $('yearDisplay');
      const monthDisplay = $('monthDisplay');
      const yearSelector = $('yearSelector');
      const yearPickerOverlay = $('yearPickerOverlay');
      const yearWheel = $('yearWheel');
      const wheelContainer = $('wheelContainer');
      const yearCancelBtn = $('yearCancelBtn');
      const yearDoneBtn = $('yearDoneBtn');
      const calendarWrapper = $('calendarWrapper');
      const calendarSlider = $('calendarSlider');
      const prevCalendar = $('prevCalendar');
      const currentCalendar = $('currentCalendar');
      const nextCalendar = $('nextCalendar');
      const logDate = $('logDate');
      const logList = $('logList');
      const logEmpty = $('logEmpty');
      const editInput = $('editInput');
      const addBtn = $('addBtn');
      const editLogList = $('editLogList');

      // ═══════════════════════════════
      // ユーティリティ関数
      // ═══════════════════════════════
      function formatDateKey(year, month, day) {
        return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      }

      // ═══════════════════════════════
      // 日本の祝日判定
      // ═══════════════════════════════
      const holidayCache = {};

      function getHolidays(year) {
        if (holidayCache[year]) return holidayCache[year];

        const holidays = {};

        // 固定祝日
        holidays[`${year}-01-01`] = '元日';
        holidays[`${year}-02-11`] = '建国記念の日';
        holidays[`${year}-02-23`] = '天皇誕生日';
        holidays[`${year}-04-29`] = '昭和の日';
        holidays[`${year}-05-03`] = '憲法記念日';
        holidays[`${year}-05-04`] = 'みどりの日';
        holidays[`${year}-05-05`] = 'こどもの日';
        holidays[`${year}-08-11`] = '山の日';
        holidays[`${year}-11-03`] = '文化の日';
        holidays[`${year}-11-23`] = '勤労感謝の日';

        // ハッピーマンデー（第n月曜日）
        holidays[getNthMonday(year, 1, 2)] = '成人の日';
        holidays[getNthMonday(year, 7, 3)] = '海の日';
        holidays[getNthMonday(year, 9, 3)] = '敬老の日';
        holidays[getNthMonday(year, 10, 2)] = 'スポーツの日';

        // 春分・秋分（天文学的近似式）
        holidays[getVernalEquinox(year)] = '春分の日';
        holidays[getAutumnalEquinox(year)] = '秋分の日';

        // 振替休日を追加
        addSubstituteHolidays(year, holidays);

        // 国民の休日（祝日に挟まれた平日）
        addCitizensHoliday(year, holidays);

        holidayCache[year] = holidays;
        return holidays;
      }

      // 第n月曜日を取得
      function getNthMonday(year, month, n) {
        const firstDay = new Date(year, month - 1, 1).getDay();
        const firstMonday = firstDay === 0 ? 2 : (firstDay === 1 ? 1 : 9 - firstDay);
        const day = firstMonday + (n - 1) * 7;
        return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      }

      // 春分の日（近似式、2000-2099年）
      function getVernalEquinox(year) {
        const day = Math.floor(20.8431 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4));
        return `${year}-03-${String(day).padStart(2, '0')}`;
      }

      // 秋分の日（近似式、2000-2099年）
      function getAutumnalEquinox(year) {
        const day = Math.floor(23.2488 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4));
        return `${year}-09-${String(day).padStart(2, '0')}`;
      }

      // 振替休日（祝日が日曜の場合、翌平日が休み）
      function addSubstituteHolidays(year, holidays) {
        const baseHolidays = Object.keys(holidays).filter(d => d.startsWith(`${year}-`));
        
        for (const dateKey of baseHolidays) {
          const [y, m, d] = dateKey.split('-').map(Number);
          const date = new Date(y, m - 1, d);
          
          if (date.getDay() === 0) { // 日曜日
            let nextDay = new Date(y, m - 1, d + 1);
            let nextKey = formatDateKey(nextDay.getFullYear(), nextDay.getMonth(), nextDay.getDate());
            
            // 次の平日を探す（連続祝日対応）
            while (holidays[nextKey]) {
              nextDay.setDate(nextDay.getDate() + 1);
              nextKey = formatDateKey(nextDay.getFullYear(), nextDay.getMonth(), nextDay.getDate());
            }
            
            holidays[nextKey] = '振替休日';
          }
        }
      }

      // 国民の休日（祝日に挟まれた平日）
      function addCitizensHoliday(year, holidays) {
        // 主に9月に発生（敬老の日と秋分の日の間）
        const keiro = getNthMonday(year, 9, 3);
        const shubun = getAutumnalEquinox(year);
        
        const keiroDate = new Date(keiro);
        const shubunDate = new Date(shubun);
        const diff = (shubunDate - keiroDate) / (1000 * 60 * 60 * 24);
        
        if (diff === 2) {
          const middleDate = new Date(keiroDate);
          middleDate.setDate(middleDate.getDate() + 1);
          const middleKey = formatDateKey(middleDate.getFullYear(), middleDate.getMonth(), middleDate.getDate());
          if (!holidays[middleKey]) {
            holidays[middleKey] = '国民の休日';
          }
        }
      }

      // 祝日かどうか判定
      function isHoliday(year, month, day) {
        const holidays = getHolidays(year);
        const dateKey = formatDateKey(year, month, day);
        return holidays[dateKey] || null;
      }

      function formatDisplayDate(year, month, day) {
        const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
        const date = new Date(year, month, day);
        return `${year}年${month + 1}月${day}日（${weekdays[date.getDay()]}）`;
      }

      function getDaysInMonth(year, month) {
        return new Date(year, month + 1, 0).getDate();
      }

      function getFirstDayOfMonth(year, month) {
        return new Date(year, month, 1).getDay();
      }

      function isToday(year, month, day) {
        const today = new Date();
        return today.getFullYear() === year && 
               today.getMonth() === month && 
               today.getDate() === day;
      }

      function getTaskCount(dateKey) {
        return logData[dateKey] ? logData[dateKey].length : 0;
      }

      // ═══════════════════════════════
      // カレンダー描画
      // ═══════════════════════════════
      function renderCalendar(container, year, month) {
        container.innerHTML = '';
        
        const daysInMonth = getDaysInMonth(year, month);
        const firstDay = getFirstDayOfMonth(year, month);
        const daysInPrevMonth = getDaysInMonth(year, month - 1);

        // 前月の日付
        for (let i = firstDay - 1; i >= 0; i--) {
          const day = daysInPrevMonth - i;
          const prevMonth = month === 0 ? 11 : month - 1;
          const prevYear = month === 0 ? year - 1 : year;
          container.appendChild(createDayElement(prevYear, prevMonth, day, true));
        }

        // 当月の日付
        for (let day = 1; day <= daysInMonth; day++) {
          container.appendChild(createDayElement(year, month, day, false));
        }

        // 次月の日付（6行になるまで）
        const totalCells = container.children.length;
        const remainingCells = totalCells <= 35 ? 35 - totalCells : 42 - totalCells;
        for (let day = 1; day <= remainingCells; day++) {
          const nextMonth = month === 11 ? 0 : month + 1;
          const nextYear = month === 11 ? year + 1 : year;
          container.appendChild(createDayElement(nextYear, nextMonth, day, true));
        }
      }

      function createDayElement(year, month, day, isOtherMonth) {
        const el = document.createElement('div');
        el.className = 'day';
        
        const date = new Date(year, month, day);
        const dayOfWeek = date.getDay();
        const holidayName = isHoliday(year, month, day);
        
        if (isOtherMonth) el.classList.add('other-month');
        if (dayOfWeek === 0) el.classList.add('sunday');
        if (dayOfWeek === 6) el.classList.add('saturday');
        if (holidayName) el.classList.add('holiday');
        if (isToday(year, month, day)) el.classList.add('today');

        const dateKey = formatDateKey(year, month, day);
        if (selectedDate === dateKey) el.classList.add('selected');

        // 日付番号
        const numEl = document.createElement('span');
        numEl.className = 'day-number';
        numEl.textContent = day;
        el.appendChild(numEl);

        // インジケーター
        const count = getTaskCount(dateKey);
        if (count > 0) {
          const indicator = document.createElement('div');
          indicator.className = 'indicator';
          indicator.dataset.count = Math.min(count, 4);

          // 3件の場合はセグメント要素を追加
          if (count === 3) {
            for (let i = 0; i < 3; i++) {
              const seg = document.createElement('span');
              seg.className = 'seg';
              indicator.appendChild(seg);
            }
          }

          el.appendChild(indicator);
        }

        // クリックイベント
        el.addEventListener('click', () => selectDate(year, month, day, isOtherMonth));

        return el;
      }

      function renderAllCalendars() {
        const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
        const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
        const nextMonth = currentMonth === 11 ? 0 : currentMonth + 1;
        const nextYear = currentMonth === 11 ? currentYear + 1 : currentYear;

        renderCalendar(prevCalendar, prevYear, prevMonth);
        renderCalendar(currentCalendar, currentYear, currentMonth);
        renderCalendar(nextCalendar, nextYear, nextMonth);

        calendarSlider.style.transition = 'none';
        calendarSlider.style.transform = 'translateX(-100%)';
      }

      function updateHeader() {
        yearDisplay.textContent = currentYear;
        monthDisplay.textContent = `${currentMonth + 1}月`;
      }

      // ═══════════════════════════════
      // 日付選択
      // ═══════════════════════════════
      function selectDate(year, month, day, isOtherMonth) {
        if (isOtherMonth) {
          // 別の月をタップした場合はその月に移動
          currentYear = year;
          currentMonth = month;
          updateHeader();
          renderAllCalendars();
        }

        selectedDate = formatDateKey(year, month, day);
        
        // 選択状態を更新
        document.querySelectorAll('.day.selected').forEach(el => el.classList.remove('selected'));
        document.querySelectorAll('.day').forEach(el => {
          const numEl = el.querySelector('.day-number');
          if (numEl && el.dataset) {
            // 日付の特定（簡易的）
          }
        });

        renderAllCalendars();
        renderLog(year, month, day);
      }

      function renderLog(year, month, day) {
        const dateKey = formatDateKey(year, month, day);
        const logs = logData[dateKey] || [];
        const holidayName = isHoliday(year, month, day);

        let dateText = formatDisplayDate(year, month, day);
        if (holidayName) {
          dateText += ` — ${holidayName}`;
        }
        logDate.textContent = dateText;

        if (logs.length === 0) {
          logList.classList.add('hidden');
          logEmpty.classList.remove('hidden');
        } else {
          logList.classList.remove('hidden');
          logEmpty.classList.add('hidden');
          
          logList.innerHTML = logs.map(log => 
            `<li class="log-item">${escapeHtml(log)}</li>`
          ).join('');
        }

        // 編集モード時のリスト
        if (isEditMode) {
          renderEditLogList(dateKey, logs);
        }
      }

      function renderEditLogList(dateKey, logs) {
        editLogList.innerHTML = logs.map((log, index) => `
          <div class="edit-log-item">
            <span class="edit-log-text">${escapeHtml(log)}</span>
            <button class="edit-log-delete" data-date="${dateKey}" data-index="${index}">削除</button>
          </div>
        `).join('');

        // 削除ボタンのイベント
        editLogList.querySelectorAll('.edit-log-delete').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const date = e.target.dataset.date;
            const index = parseInt(e.target.dataset.index);
            deleteLog(date, index);
          });
        });
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ═══════════════════════════════
      // スワイプ処理
      // ═══════════════════════════════
      let touchStartX = 0;
      let touchStartY = 0;
      let touchDeltaX = 0;
      let isSwiping = false;

      calendarWrapper.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        touchDeltaX = 0;
        isSwiping = false;
        calendarSlider.style.transition = 'none';
      }, { passive: true });

      calendarWrapper.addEventListener('touchmove', (e) => {
        const deltaX = e.touches[0].clientX - touchStartX;
        const deltaY = e.touches[0].clientY - touchStartY;

        // 横スワイプの判定
        if (!isSwiping && Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
          isSwiping = true;
        }

        if (isSwiping) {
          touchDeltaX = deltaX;
          const baseOffset = -100;
          const movePercent = (deltaX / calendarWrapper.offsetWidth) * 100;
          calendarSlider.style.transform = `translateX(${baseOffset + movePercent}%)`;
        }
      }, { passive: true });

      calendarWrapper.addEventListener('touchend', () => {
        if (!isSwiping) return;

        const threshold = calendarWrapper.offsetWidth * 0.2;
        calendarSlider.style.transition = 'transform 0.3s cubic-bezier(0.32, 0.72, 0, 1)';

        if (touchDeltaX > threshold) {
          // 前月へ
          calendarSlider.style.transform = 'translateX(0%)';
          setTimeout(() => {
            goToPrevMonth();
          }, 300);
        } else if (touchDeltaX < -threshold) {
          // 次月へ
          calendarSlider.style.transform = 'translateX(-200%)';
          setTimeout(() => {
            goToNextMonth();
          }, 300);
        } else {
          // 戻す
          calendarSlider.style.transform = 'translateX(-100%)';
        }
      });

      // ═══════════════════════════════
      // PCマウスホイール操作
      // ═══════════════════════════════
      let wheelTimeout = null;
      let isWheelAnimating = false;

      calendarWrapper.addEventListener('wheel', (e) => {
        e.preventDefault();
        
        if (isWheelAnimating) return;

        // スクロール方向を判定
        if (e.deltaY > 0) {
          // 下スクロール → 前月へ
          isWheelAnimating = true;
          calendarSlider.style.transition = 'transform 0.3s cubic-bezier(0.32, 0.72, 0, 1)';
          calendarSlider.style.transform = 'translateX(0%)';
          setTimeout(() => {
            goToPrevMonth();
            isWheelAnimating = false;
          }, 300);
        } else if (e.deltaY < 0) {
          // 上スクロール → 次月へ
          isWheelAnimating = true;
          calendarSlider.style.transition = 'transform 0.3s cubic-bezier(0.32, 0.72, 0, 1)';
          calendarSlider.style.transform = 'translateX(-200%)';
          setTimeout(() => {
            goToNextMonth();
            isWheelAnimating = false;
          }, 300);
        }
      }, { passive: false });

      function goToPrevMonth() {
        if (currentMonth === 0) {
          if (currentYear > START_YEAR) {
            currentYear--;
            currentMonth = 11;
          } else {
            renderAllCalendars();
            return;
          }
        } else {
          currentMonth--;
        }
        updateHeader();
        renderAllCalendars();
      }

      function goToNextMonth() {
        if (currentMonth === 11) {
          if (currentYear < END_YEAR) {
            currentYear++;
            currentMonth = 0;
          } else {
            renderAllCalendars();
            return;
          }
        } else {
          currentMonth++;
        }
        updateHeader();
        renderAllCalendars();
      }

      // ═══════════════════════════════
      // 年ホイールピッカー
      // ═══════════════════════════════
      const ITEM_HEIGHT = 36;
      let wheelOffset = 0;
      let wheelStartY = 0;
      let wheelVelocity = 0;
      let lastWheelY = 0;
      let lastWheelTime = 0;

      function initYearWheel() {
        yearWheel.innerHTML = '';
        for (let year = START_YEAR; year <= END_YEAR; year++) {
          const item = document.createElement('div');
          item.className = 'wheel-item';
          item.textContent = year;
          item.dataset.year = year;
          yearWheel.appendChild(item);
        }
        setWheelPosition(currentYear - START_YEAR, false);
      }

      function setWheelPosition(index, animate = true) {
        wheelOffset = -index * ITEM_HEIGHT;
        yearWheel.style.transition = animate ? 'transform 0.3s cubic-bezier(0.32, 0.72, 0, 1)' : 'none';
        yearWheel.style.transform = `translateY(${wheelOffset}px)`;
        updateWheelSelection(index);
        tempSelectedYear = START_YEAR + index;
      }

      function updateWheelSelection(selectedIndex) {
        yearWheel.querySelectorAll('.wheel-item').forEach((item, i) => {
          item.classList.toggle('selected', i === selectedIndex);
        });
      }

      function openYearPicker() {
        tempSelectedYear = currentYear;
        setWheelPosition(currentYear - START_YEAR, false);
        yearPickerOverlay.classList.add('active');
      }

      function closeYearPicker() {
        yearPickerOverlay.classList.remove('active');
      }

      yearSelector.addEventListener('click', openYearPicker);
      yearCancelBtn.addEventListener('click', closeYearPicker);
      yearDoneBtn.addEventListener('click', () => {
        currentYear = tempSelectedYear;
        currentMonth = 0;
        updateHeader();
        renderAllCalendars();
        closeYearPicker();
      });

      yearPickerOverlay.addEventListener('click', (e) => {
        if (e.target === yearPickerOverlay) closeYearPicker();
      });

      // ホイールタッチ操作
      wheelContainer.addEventListener('touchstart', (e) => {
        wheelStartY = e.touches[0].clientY;
        lastWheelY = wheelStartY;
        lastWheelTime = Date.now();
        wheelVelocity = 0;
        yearWheel.style.transition = 'none';
      }, { passive: true });

      wheelContainer.addEventListener('touchmove', (e) => {
        const currentY = e.touches[0].clientY;
        const deltaY = currentY - wheelStartY;
        const now = Date.now();
        
        // 速度計算
        if (now - lastWheelTime > 0) {
          wheelVelocity = (currentY - lastWheelY) / (now - lastWheelTime);
        }
        lastWheelY = currentY;
        lastWheelTime = now;

        const currentIndex = tempSelectedYear - START_YEAR;
        const newOffset = -currentIndex * ITEM_HEIGHT + deltaY;
        yearWheel.style.transform = `translateY(${newOffset}px)`;
      }, { passive: true });

      wheelContainer.addEventListener('touchend', () => {
        const currentIndex = tempSelectedYear - START_YEAR;
        const deltaOffset = wheelOffset - (-currentIndex * ITEM_HEIGHT);
        
        // 慣性スクロール
        let momentum = wheelVelocity * 150;
        let targetOffset = -currentIndex * ITEM_HEIGHT + 
                          (parseFloat(yearWheel.style.transform.match(/-?\d+\.?\d*/)?.[0] || 0) - wheelOffset) +
                          momentum;

        // インデックスを計算
        let targetIndex = Math.round(-targetOffset / ITEM_HEIGHT);
        targetIndex = Math.max(0, Math.min(END_YEAR - START_YEAR, targetIndex));

        setWheelPosition(targetIndex, true);
      });

      // ═══════════════════════════════
      // データ読み込み・保存（Firebase）
      // ═══════════════════════════════
      async function loadData() {
        try {
          const snapshot = await logsRef.once('value');
          const data = snapshot.val();
          if (data) {
            logData = data;
          }
        } catch (e) {
          console.error('Firebaseからの読み込みに失敗:', e);
        }
        
        renderAllCalendars();
        
        // 今日の日付を選択
        const today = new Date();
        selectDate(today.getFullYear(), today.getMonth(), today.getDate(), false);
      }

      async function saveData() {
        try {
          await logsRef.set(logData);
          console.log('Firebaseに保存完了');
        } catch (e) {
          console.error('Firebaseへの保存に失敗:', e);
          alert('保存に失敗しました。ネットワーク接続を確認してください。');
        }
      }

      // ═══════════════════════════════
      // 編集機能
      // ═══════════════════════════════
      function addLog(dateKey, text) {
        if (!text.trim()) return;
        
        if (!logData[dateKey]) {
          logData[dateKey] = [];
        }
        logData[dateKey].push(text.trim());
        saveData();
        
        // 再描画
        const [year, month, day] = dateKey.split('-').map(Number);
        renderAllCalendars();
        renderLog(year, month - 1, day);
      }

      function deleteLog(dateKey, index) {
        if (!logData[dateKey]) return;
        
        logData[dateKey].splice(index, 1);
        if (logData[dateKey].length === 0) {
          delete logData[dateKey];
        }
        saveData();
        
        // 再描画
        const [year, month, day] = dateKey.split('-').map(Number);
        renderAllCalendars();
        renderLog(year, month - 1, day);
      }

      // 編集UIのイベント
      if (isEditMode) {
        document.body.classList.add('edit-mode');
        
        addBtn.addEventListener('click', () => {
          if (selectedDate) {
            addLog(selectedDate, editInput.value);
            editInput.value = '';
          }
        });

        editInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && selectedDate) {
            addLog(selectedDate, editInput.value);
            editInput.value = '';
          }
        });
      }

      // ═══════════════════════════════
      // 初期化
      // ═══════════════════════════════
      function init() {
        initYearWheel();
        updateHeader();
        loadData();
      }

      init();
    });
  </script>
</body>
</html>
