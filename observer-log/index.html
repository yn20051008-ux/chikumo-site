<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>開発者記録 - 畜物語</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  
  <script>
    // Firebase設定（グローバル）
    const firebaseConfig = {
      apiKey: "AIzaSyBw5-6oAuOmgYC_7G27Z0Qavwn78ZrkhdQ",
      authDomain: "chikumonogatarikiroku.firebaseapp.com",
      databaseURL: "https://chikumonogatarikiroku-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "chikumonogatarikiroku",
      storageBucket: "chikumonogatarikiroku.firebasestorage.app",
      messagingSenderId: "725202431277",
      appId: "1:725202431277:web:c49c911cfcae26d63ab7a4"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <style>
    /* ━━━━━━━━━━━━━━━━━━━━━━
       BASE / RESET
    ━━━━━━━━━━━━━━━━━━━━━━ */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 16px;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", sans-serif;
      background: #000;
      color: #fff;
      min-height: 100dvh;
      overflow-x: hidden;
      line-height: 1.5;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       LAYOUT
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .container {
      max-width: 430px;
      margin: 0 auto;
      padding: 0 16px 32px;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       HEADER - 年月表示
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 20px 0 16px;
    }

    .selector {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .selector::after {
      content: '';
      width: 6px;
      height: 6px;
      border-right: 1.5px solid currentColor;
      border-bottom: 1.5px solid currentColor;
      transform: rotate(45deg);
      margin-top: -2px;
    }

    .year-selector {
      font-size: 17px;
      font-weight: 600;
      color: #ff3b30;
    }

    .month-selector {
      font-size: 17px;
      font-weight: 600;
      color: #fff;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       ホイールピッカー共通
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .picker-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .picker-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .picker {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1c1c1e;
      border-radius: 12px 12px 0 0;
      z-index: 101;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    }

    .picker-overlay.active .picker {
      transform: translateY(0);
    }

    .picker-header {
      display: flex;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid #38383a;
    }

    .picker-btn {
      background: none;
      border: none;
      color: #ff3b30;
      font-size: 17px;
      font-weight: 400;
      cursor: pointer;
    }

    .picker-btn.done {
      font-weight: 600;
    }

    .wheel-container {
      height: 216px;
      position: relative;
      overflow: hidden;
      -webkit-mask-image: linear-gradient(to bottom, transparent, black 30%, black 70%, transparent);
      mask-image: linear-gradient(to bottom, transparent, black 30%, black 70%, transparent);
    }

    .wheel {
      position: absolute;
      width: 100%;
      top: 50%;
      transform: translateY(-50%);
      transition: transform 0.1s ease-out;
    }

    .wheel-item {
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      color: #fff;
      opacity: 0.4;
      transition: opacity 0.2s;
    }

    .wheel-item.selected {
      opacity: 1;
      font-weight: 500;
    }

    .wheel-highlight {
      position: absolute;
      top: 50%;
      left: 16px;
      right: 16px;
      height: 36px;
      transform: translateY(-50%);
      border-bottom: 0.5px solid #48484a;
      pointer-events: none;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       WEEKDAY HEADER
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      padding: 8px 0;
      border-bottom: 0.5px solid #38383a;
    }

    .weekday {
      font-size: 11px;
      font-weight: 600;
      color: #8e8e93;
      text-transform: uppercase;
    }

    .weekday:first-child {
      color: #ff3b30;
    }

    .weekday:last-child {
      color: #007aff;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       CALENDAR GRID
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px 0;
      padding: 8px 0;
    }

    .day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
      border-radius: 50%;
      transition: background 0.15s;
    }

    .day:active {
      background: rgba(255, 255, 255, 0.1);
    }

    .day.other-month {
      opacity: 0.3;
    }

    .day-number {
      font-size: 16px;
      font-weight: 400;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .day.today .day-number {
      background: #ff3b30;
      color: #fff;
      font-weight: 500;
    }

    .day.selected:not(.today) .day-number {
      background: #48484a;
    }

    .day.sunday .day-number {
      color: #ff6961;
    }

    .day.saturday .day-number {
      color: #64d2ff;
    }

    .day.today.sunday .day-number,
    .day.today.saturday .day-number {
      color: #fff;
    }

    .day.holiday .day-number {
      color: #ff6961;
    }

    .day.today.holiday .day-number {
      color: #fff;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       TASK INDICATORS
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .indicator {
      height: 4px;
      border-radius: 2px;
      display: flex;
      gap: 1px;
      overflow: hidden;
    }

    .indicator[data-count="1"] {
      width: 4px;
      background: #ff6b9d;
    }

    .indicator[data-count="2"] {
      width: 16px;
    }

    .indicator[data-count="2"]::before {
      content: '';
      flex: 1;
      background: #ff6b9d;
      border-radius: 2px 0 0 2px;
    }

    .indicator[data-count="2"]::after {
      content: '';
      flex: 1;
      background: #5ac8fa;
      border-radius: 0 2px 2px 0;
    }

    .indicator[data-count="3"] {
      width: 24px;
    }

    .indicator[data-count="3"] .seg {
      flex: 1;
    }

    .indicator[data-count="3"] .seg:nth-child(1) {
      background: #ff6b9d;
      border-radius: 2px 0 0 2px;
    }

    .indicator[data-count="3"] .seg:nth-child(2) {
      background: #5ac8fa;
    }

    .indicator[data-count="3"] .seg:nth-child(3) {
      background: #ffd60a;
      border-radius: 0 2px 2px 0;
    }

    .indicator[data-count="4"] {
      width: 24px;
      background: #bf5af2;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       LOG SECTION
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .log-section {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 0.5px solid #38383a;
    }

    .log-date {
      font-size: 13px;
      color: #8e8e93;
      margin-bottom: 12px;
    }

    .log-list {
      list-style: none;
    }

    .log-item {
      padding: 12px 0;
      border-bottom: 0.5px solid #2c2c2e;
      font-size: 15px;
      color: #fff;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .log-item::before {
      content: '';
      width: 6px;
      height: 6px;
      background: #ff6b9d;
      border-radius: 50%;
      margin-top: 7px;
      flex-shrink: 0;
    }

    .log-item:nth-child(2)::before {
      background: #5ac8fa;
    }

    .log-item:nth-child(3)::before {
      background: #ffd60a;
    }

    .log-item:nth-child(n+4)::before {
      background: #bf5af2;
    }

    .log-empty {
      font-size: 15px;
      color: #636366;
      text-align: center;
      padding: 24px 0;
    }

    /* ━━━━━━━━━━━━━━━━━━━━━━
       EDIT MODE UI
    ━━━━━━━━━━━━━━━━━━━━━━ */
    .edit-section {
      display: none;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 0.5px solid #38383a;
    }

    .edit-mode .edit-section {
      display: block;
    }

    .edit-input-wrapper {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .edit-input {
      flex: 1;
      background: #1c1c1e;
      border: none;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 15px;
      color: #fff;
      outline: none;
    }

    .edit-input::placeholder {
      color: #636366;
    }

    .edit-input:focus {
      box-shadow: 0 0 0 1px #ff3b30;
    }

    .btn {
      background: #ff3b30;
      border: none;
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .btn:active {
      opacity: 0.7;
    }

    .edit-log-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 0.5px solid #2c2c2e;
    }

    .edit-log-text {
      font-size: 15px;
      color: #fff;
      flex: 1;
    }

    .edit-log-delete {
      background: none;
      border: none;
      color: #ff453a;
      font-size: 14px;
      cursor: pointer;
      padding: 4px 8px;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ═══════════════════════════════
         HEADER: 年・月セレクター
    ═══════════════════════════════ -->
    <header class="header">
      <div class="selector year-selector" id="yearSelector">
        <span id="yearDisplay">2026</span>
      </div>
      <div class="selector month-selector" id="monthSelector">
        <span id="monthDisplay">1月</span>
      </div>
    </header>

    <!-- ═══════════════════════════════
         曜日ヘッダー
    ═══════════════════════════════ -->
    <div class="weekdays">
      <span class="weekday">日</span>
      <span class="weekday">月</span>
      <span class="weekday">火</span>
      <span class="weekday">水</span>
      <span class="weekday">木</span>
      <span class="weekday">金</span>
      <span class="weekday">土</span>
    </div>

    <!-- ═══════════════════════════════
         カレンダーグリッド
    ═══════════════════════════════ -->
    <div class="calendar" id="calendar"></div>

    <!-- ═══════════════════════════════
         選択日のログ表示
    ═══════════════════════════════ -->
    <section class="log-section">
      <p class="log-date" id="logDate"></p>
      <ul class="log-list" id="logList"></ul>
      <p class="log-empty hidden" id="logEmpty">記録はありません</p>
    </section>

    <!-- ═══════════════════════════════
         編集UI（?edit=true時のみ表示）
    ═══════════════════════════════ -->
    <section class="edit-section">
      <div class="edit-input-wrapper">
        <input type="text" class="edit-input" id="editInput" placeholder="作業内容を入力">
        <button class="btn" id="addBtn">追加</button>
      </div>
      <div id="editLogList"></div>
    </section>
  </div>

  <!-- ═══════════════════════════════
       年ピッカー
  ═══════════════════════════════ -->
  <div class="picker-overlay" id="yearPickerOverlay">
    <div class="picker">
      <div class="picker-header">
        <button class="picker-btn" id="yearCancelBtn">キャンセル</button>
        <button class="picker-btn done" id="yearDoneBtn">完了</button>
      </div>
      <div class="wheel-container" id="yearWheelContainer">
        <div class="wheel-highlight"></div>
        <div class="wheel" id="yearWheel"></div>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════
       月ピッカー
  ═══════════════════════════════ -->
  <div class="picker-overlay" id="monthPickerOverlay">
    <div class="picker">
      <div class="picker-header">
        <button class="picker-btn" id="monthCancelBtn">キャンセル</button>
        <button class="picker-btn done" id="monthDoneBtn">完了</button>
      </div>
      <div class="wheel-container" id="monthWheelContainer">
        <div class="wheel-highlight"></div>
        <div class="wheel" id="monthWheel"></div>
      </div>
    </div>
  </div>

  <script>
    /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
       開発者記録 - 畜物語プロジェクト
       Vanilla JavaScript 実装
    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

    document.addEventListener('DOMContentLoaded', function() {
      'use strict';

      // ═══════════════════════════════
      // Firebase参照
      // ═══════════════════════════════
      const database = firebase.database();
      const logsRef = database.ref('logs');

      // ═══════════════════════════════
      // 設定
      // ═══════════════════════════════
      const START_YEAR = 2026;
      const END_YEAR = 2035;
      const ITEM_HEIGHT = 36;

      // ═══════════════════════════════
      // 状態管理
      // ═══════════════════════════════
      let currentYear = new Date().getFullYear();
      let currentMonth = new Date().getMonth();
      let selectedDate = null;
      let logData = {};
      let isEditMode = new URLSearchParams(window.location.search).get('edit') === 'true';
      
      // ホイール用一時状態
      let tempSelectedYear = currentYear;
      let tempSelectedMonth = currentMonth;

      // 開始年より前は開始年にセット
      if (currentYear < START_YEAR) {
        currentYear = START_YEAR;
        currentMonth = 0;
      }

      // ═══════════════════════════════
      // DOM要素
      // ═══════════════════════════════
      const $ = id => document.getElementById(id);
      const yearDisplay = $('yearDisplay');
      const monthDisplay = $('monthDisplay');
      const yearSelector = $('yearSelector');
      const monthSelector = $('monthSelector');
      const calendar = $('calendar');
      const logDate = $('logDate');
      const logList = $('logList');
      const logEmpty = $('logEmpty');
      const editInput = $('editInput');
      const addBtn = $('addBtn');
      const editLogList = $('editLogList');

      // 年ピッカー
      const yearPickerOverlay = $('yearPickerOverlay');
      const yearWheel = $('yearWheel');
      const yearWheelContainer = $('yearWheelContainer');
      const yearCancelBtn = $('yearCancelBtn');
      const yearDoneBtn = $('yearDoneBtn');

      // 月ピッカー
      const monthPickerOverlay = $('monthPickerOverlay');
      const monthWheel = $('monthWheel');
      const monthWheelContainer = $('monthWheelContainer');
      const monthCancelBtn = $('monthCancelBtn');
      const monthDoneBtn = $('monthDoneBtn');

      // ═══════════════════════════════
      // ユーティリティ関数
      // ═══════════════════════════════
      function formatDateKey(year, month, day) {
        return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      }

      function formatDisplayDate(year, month, day) {
        const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
        const date = new Date(year, month, day);
        return `${year}年${month + 1}月${day}日（${weekdays[date.getDay()]}）`;
      }

      function getDaysInMonth(year, month) {
        return new Date(year, month + 1, 0).getDate();
      }

      function getFirstDayOfMonth(year, month) {
        return new Date(year, month, 1).getDay();
      }

      function isToday(year, month, day) {
        const today = new Date();
        return today.getFullYear() === year && 
               today.getMonth() === month && 
               today.getDate() === day;
      }

      function getTaskCount(dateKey) {
        return logData[dateKey] ? logData[dateKey].length : 0;
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // ═══════════════════════════════
      // 日本の祝日判定
      // ═══════════════════════════════
      const holidayCache = {};

      function getHolidays(year) {
        if (holidayCache[year]) return holidayCache[year];

        const holidays = {};

        // 固定祝日
        holidays[`${year}-01-01`] = '元日';
        holidays[`${year}-02-11`] = '建国記念の日';
        holidays[`${year}-02-23`] = '天皇誕生日';
        holidays[`${year}-04-29`] = '昭和の日';
        holidays[`${year}-05-03`] = '憲法記念日';
        holidays[`${year}-05-04`] = 'みどりの日';
        holidays[`${year}-05-05`] = 'こどもの日';
        holidays[`${year}-08-11`] = '山の日';
        holidays[`${year}-11-03`] = '文化の日';
        holidays[`${year}-11-23`] = '勤労感謝の日';

        // ハッピーマンデー
        holidays[getNthMonday(year, 1, 2)] = '成人の日';
        holidays[getNthMonday(year, 7, 3)] = '海の日';
        holidays[getNthMonday(year, 9, 3)] = '敬老の日';
        holidays[getNthMonday(year, 10, 2)] = 'スポーツの日';

        // 春分・秋分
        holidays[getVernalEquinox(year)] = '春分の日';
        holidays[getAutumnalEquinox(year)] = '秋分の日';

        // 振替休日
        addSubstituteHolidays(year, holidays);

        // 国民の休日
        addCitizensHoliday(year, holidays);

        holidayCache[year] = holidays;
        return holidays;
      }

      function getNthMonday(year, month, n) {
        const firstDay = new Date(year, month - 1, 1).getDay();
        const firstMonday = firstDay === 0 ? 2 : (firstDay === 1 ? 1 : 9 - firstDay);
        const day = firstMonday + (n - 1) * 7;
        return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      }

      function getVernalEquinox(year) {
        const day = Math.floor(20.8431 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4));
        return `${year}-03-${String(day).padStart(2, '0')}`;
      }

      function getAutumnalEquinox(year) {
        const day = Math.floor(23.2488 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4));
        return `${year}-09-${String(day).padStart(2, '0')}`;
      }

      function addSubstituteHolidays(year, holidays) {
        const baseHolidays = Object.keys(holidays).filter(d => d.startsWith(`${year}-`));
        
        for (const dateKey of baseHolidays) {
          const [y, m, d] = dateKey.split('-').map(Number);
          const date = new Date(y, m - 1, d);
          
          if (date.getDay() === 0) {
            let nextDay = new Date(y, m - 1, d + 1);
            let nextKey = formatDateKey(nextDay.getFullYear(), nextDay.getMonth(), nextDay.getDate());
            
            while (holidays[nextKey]) {
              nextDay.setDate(nextDay.getDate() + 1);
              nextKey = formatDateKey(nextDay.getFullYear(), nextDay.getMonth(), nextDay.getDate());
            }
            
            holidays[nextKey] = '振替休日';
          }
        }
      }

      function addCitizensHoliday(year, holidays) {
        const keiro = getNthMonday(year, 9, 3);
        const shubun = getAutumnalEquinox(year);
        
        const keiroDate = new Date(keiro);
        const shubunDate = new Date(shubun);
        const diff = (shubunDate - keiroDate) / (1000 * 60 * 60 * 24);
        
        if (diff === 2) {
          const middleDate = new Date(keiroDate);
          middleDate.setDate(middleDate.getDate() + 1);
          const middleKey = formatDateKey(middleDate.getFullYear(), middleDate.getMonth(), middleDate.getDate());
          if (!holidays[middleKey]) {
            holidays[middleKey] = '国民の休日';
          }
        }
      }

      function isHoliday(year, month, day) {
        const holidays = getHolidays(year);
        const dateKey = formatDateKey(year, month, day);
        return holidays[dateKey] || null;
      }

      // ═══════════════════════════════
      // カレンダー描画
      // ═══════════════════════════════
      function renderCalendar() {
        calendar.innerHTML = '';
        
        const daysInMonth = getDaysInMonth(currentYear, currentMonth);
        const firstDay = getFirstDayOfMonth(currentYear, currentMonth);
        const daysInPrevMonth = getDaysInMonth(currentYear, currentMonth - 1);

        // 前月の日付
        for (let i = firstDay - 1; i >= 0; i--) {
          const day = daysInPrevMonth - i;
          const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
          const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
          calendar.appendChild(createDayElement(prevYear, prevMonth, day, true));
        }

        // 当月の日付
        for (let day = 1; day <= daysInMonth; day++) {
          calendar.appendChild(createDayElement(currentYear, currentMonth, day, false));
        }

        // 次月の日付
        const totalCells = calendar.children.length;
        const remainingCells = totalCells <= 35 ? 35 - totalCells : 42 - totalCells;
        for (let day = 1; day <= remainingCells; day++) {
          const nextMonth = currentMonth === 11 ? 0 : currentMonth + 1;
          const nextYear = currentMonth === 11 ? currentYear + 1 : currentYear;
          calendar.appendChild(createDayElement(nextYear, nextMonth, day, true));
        }
      }

      function createDayElement(year, month, day, isOtherMonth) {
        const el = document.createElement('div');
        el.className = 'day';
        
        const date = new Date(year, month, day);
        const dayOfWeek = date.getDay();
        const holidayName = isHoliday(year, month, day);
        
        if (isOtherMonth) el.classList.add('other-month');
        if (dayOfWeek === 0) el.classList.add('sunday');
        if (dayOfWeek === 6) el.classList.add('saturday');
        if (holidayName) el.classList.add('holiday');
        if (isToday(year, month, day)) el.classList.add('today');

        const dateKey = formatDateKey(year, month, day);
        if (selectedDate === dateKey) el.classList.add('selected');

        // 日付番号
        const numEl = document.createElement('span');
        numEl.className = 'day-number';
        numEl.textContent = day;
        el.appendChild(numEl);

        // インジケーター
        const count = getTaskCount(dateKey);
        if (count > 0) {
          const indicator = document.createElement('div');
          indicator.className = 'indicator';
          indicator.dataset.count = Math.min(count, 4);

          if (count === 3) {
            for (let i = 0; i < 3; i++) {
              const seg = document.createElement('span');
              seg.className = 'seg';
              indicator.appendChild(seg);
            }
          }

          el.appendChild(indicator);
        }

        // クリックイベント
        el.addEventListener('click', () => selectDate(year, month, day, isOtherMonth));

        return el;
      }

      function updateHeader() {
        yearDisplay.textContent = currentYear;
        monthDisplay.textContent = `${currentMonth + 1}月`;
      }

      // ═══════════════════════════════
      // 日付選択
      // ═══════════════════════════════
      function selectDate(year, month, day, isOtherMonth) {
        if (isOtherMonth) {
          currentYear = year;
          currentMonth = month;
          updateHeader();
        }

        selectedDate = formatDateKey(year, month, day);
        renderCalendar();
        renderLog(year, month, day);
      }

      function renderLog(year, month, day) {
        const dateKey = formatDateKey(year, month, day);
        const logs = logData[dateKey] || [];
        const holidayName = isHoliday(year, month, day);

        let dateText = formatDisplayDate(year, month, day);
        if (holidayName) {
          dateText += ` — ${holidayName}`;
        }
        logDate.textContent = dateText;

        if (logs.length === 0) {
          logList.classList.add('hidden');
          logEmpty.classList.remove('hidden');
        } else {
          logList.classList.remove('hidden');
          logEmpty.classList.add('hidden');
          
          logList.innerHTML = logs.map(log => 
            `<li class="log-item">${escapeHtml(log)}</li>`
          ).join('');
        }

        if (isEditMode) {
          renderEditLogList(dateKey, logs);
        }
      }

      function renderEditLogList(dateKey, logs) {
        editLogList.innerHTML = logs.map((log, index) => `
          <div class="edit-log-item">
            <span class="edit-log-text">${escapeHtml(log)}</span>
            <button class="edit-log-delete" data-date="${dateKey}" data-index="${index}">削除</button>
          </div>
        `).join('');

        editLogList.querySelectorAll('.edit-log-delete').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const date = e.target.dataset.date;
            const index = parseInt(e.target.dataset.index);
            deleteLog(date, index);
          });
        });
      }

      // ═══════════════════════════════
      // 年ホイールピッカー
      // ═══════════════════════════════
      function initYearWheel() {
        yearWheel.innerHTML = '';
        for (let year = START_YEAR; year <= END_YEAR; year++) {
          const item = document.createElement('div');
          item.className = 'wheel-item';
          item.textContent = year;
          yearWheel.appendChild(item);
        }
      }

      function setYearWheelPosition(index, animate = true) {
        index = Math.max(0, Math.min(END_YEAR - START_YEAR, index));
        yearWheel.style.transition = animate ? 'transform 0.3s cubic-bezier(0.32, 0.72, 0, 1)' : 'none';
        yearWheel.style.transform = `translateY(${-index * ITEM_HEIGHT}px)`;
        yearWheel.querySelectorAll('.wheel-item').forEach((item, i) => {
          item.classList.toggle('selected', i === index);
        });
        tempSelectedYear = START_YEAR + index;
      }

      function openYearPicker() {
        tempSelectedYear = currentYear;
        setYearWheelPosition(currentYear - START_YEAR, false);
        yearPickerOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeYearPicker() {
        yearPickerOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      yearSelector.addEventListener('click', openYearPicker);
      yearCancelBtn.addEventListener('click', closeYearPicker);
      yearDoneBtn.addEventListener('click', () => {
        currentYear = tempSelectedYear;
        updateHeader();
        renderCalendar();
        closeYearPicker();
      });
      yearPickerOverlay.addEventListener('click', (e) => {
        if (e.target === yearPickerOverlay) closeYearPicker();
      });

      // 年ホイールキーボード操作
      function handleYearKeydown(e) {
        if (!yearPickerOverlay.classList.contains('active')) return;
        
        switch (e.key) {
          case 'ArrowUp':
            e.preventDefault();
            setYearWheelPosition(tempSelectedYear - START_YEAR - 1, true);
            break;
          case 'ArrowDown':
            e.preventDefault();
            setYearWheelPosition(tempSelectedYear - START_YEAR + 1, true);
            break;
          case 'Enter':
            e.preventDefault();
            currentYear = tempSelectedYear;
            updateHeader();
            renderCalendar();
            closeYearPicker();
            break;
          case 'Escape':
            e.preventDefault();
            closeYearPicker();
            break;
        }
      }

      // 年ホイールタッチ操作
      let yearStartY = 0;
      let yearLastY = 0;
      let yearLastTime = 0;
      let yearVelocity = 0;

      yearWheelContainer.addEventListener('touchstart', (e) => {
        yearStartY = e.touches[0].clientY;
        yearLastY = yearStartY;
        yearLastTime = Date.now();
        yearVelocity = 0;
        yearWheel.style.transition = 'none';
      }, { passive: true });

      yearWheelContainer.addEventListener('touchmove', (e) => {
        const currentY = e.touches[0].clientY;
        const deltaY = currentY - yearStartY;
        const now = Date.now();
        
        if (now - yearLastTime > 0) {
          yearVelocity = (currentY - yearLastY) / (now - yearLastTime);
        }
        yearLastY = currentY;
        yearLastTime = now;

        const newOffset = -(tempSelectedYear - START_YEAR) * ITEM_HEIGHT + deltaY;
        yearWheel.style.transform = `translateY(${newOffset}px)`;
      }, { passive: true });

      yearWheelContainer.addEventListener('touchend', () => {
        const currentOffset = parseFloat(yearWheel.style.transform.match(/-?\d+\.?\d*/)?.[0] || 0);
        const momentum = yearVelocity * 150;
        const targetOffset = currentOffset + momentum;

        let targetIndex = Math.round(-targetOffset / ITEM_HEIGHT);
        setYearWheelPosition(targetIndex, true);
      });

      yearWheelContainer.addEventListener('wheel', (e) => {
        e.preventDefault();
        const currentIndex = tempSelectedYear - START_YEAR;
        let newIndex = currentIndex + (e.deltaY > 0 ? 1 : -1);
        setYearWheelPosition(newIndex, true);
      }, { passive: false });

      // ═══════════════════════════════
      // 月ホイールピッカー
      // ═══════════════════════════════
      function initMonthWheel() {
        monthWheel.innerHTML = '';
        for (let month = 1; month <= 12; month++) {
          const item = document.createElement('div');
          item.className = 'wheel-item';
          item.textContent = `${month}月`;
          monthWheel.appendChild(item);
        }
      }

      function setMonthWheelPosition(index, animate = true) {
        // 月のループ処理
        if (index < 0) {
          if (tempSelectedYear > START_YEAR) {
            tempSelectedYear--;
            index = 11;
          } else {
            index = 0;
          }
        } else if (index > 11) {
          if (tempSelectedYear < END_YEAR) {
            tempSelectedYear++;
            index = 0;
          } else {
            index = 11;
          }
        }

        monthWheel.style.transition = animate ? 'transform 0.3s cubic-bezier(0.32, 0.72, 0, 1)' : 'none';
        monthWheel.style.transform = `translateY(${-index * ITEM_HEIGHT}px)`;
        monthWheel.querySelectorAll('.wheel-item').forEach((item, i) => {
          item.classList.toggle('selected', i === index);
        });
        tempSelectedMonth = index;
      }

      function openMonthPicker() {
        tempSelectedYear = currentYear;
        tempSelectedMonth = currentMonth;
        setMonthWheelPosition(currentMonth, false);
        monthPickerOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeMonthPicker() {
        monthPickerOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      monthSelector.addEventListener('click', openMonthPicker);
      monthCancelBtn.addEventListener('click', closeMonthPicker);
      monthDoneBtn.addEventListener('click', () => {
        currentYear = tempSelectedYear;
        currentMonth = tempSelectedMonth;
        updateHeader();
        renderCalendar();
        closeMonthPicker();
      });
      monthPickerOverlay.addEventListener('click', (e) => {
        if (e.target === monthPickerOverlay) closeMonthPicker();
      });

      // 月ホイールキーボード操作
      function handleMonthKeydown(e) {
        if (!monthPickerOverlay.classList.contains('active')) return;
        
        switch (e.key) {
          case 'ArrowUp':
            e.preventDefault();
            setMonthWheelPosition(tempSelectedMonth - 1, true);
            break;
          case 'ArrowDown':
            e.preventDefault();
            setMonthWheelPosition(tempSelectedMonth + 1, true);
            break;
          case 'Enter':
            e.preventDefault();
            currentYear = tempSelectedYear;
            currentMonth = tempSelectedMonth;
            updateHeader();
            renderCalendar();
            closeMonthPicker();
            break;
          case 'Escape':
            e.preventDefault();
            closeMonthPicker();
            break;
        }
      }

      // キーボードイベントリスナー
      document.addEventListener('keydown', (e) => {
        handleYearKeydown(e);
        handleMonthKeydown(e);
      });

      // 月ホイールタッチ操作
      let monthStartY = 0;
      let monthLastY = 0;
      let monthLastTime = 0;
      let monthVelocity = 0;

      monthWheelContainer.addEventListener('touchstart', (e) => {
        monthStartY = e.touches[0].clientY;
        monthLastY = monthStartY;
        monthLastTime = Date.now();
        monthVelocity = 0;
        monthWheel.style.transition = 'none';
      }, { passive: true });

      monthWheelContainer.addEventListener('touchmove', (e) => {
        const currentY = e.touches[0].clientY;
        const deltaY = currentY - monthStartY;
        const now = Date.now();
        
        if (now - monthLastTime > 0) {
          monthVelocity = (currentY - monthLastY) / (now - monthLastTime);
        }
        monthLastY = currentY;
        monthLastTime = now;

        const newOffset = -tempSelectedMonth * ITEM_HEIGHT + deltaY;
        monthWheel.style.transform = `translateY(${newOffset}px)`;
      }, { passive: true });

      monthWheelContainer.addEventListener('touchend', () => {
        const currentOffset = parseFloat(monthWheel.style.transform.match(/-?\d+\.?\d*/)?.[0] || 0);
        const momentum = monthVelocity * 150;
        const targetOffset = currentOffset + momentum;

        let targetIndex = Math.round(-targetOffset / ITEM_HEIGHT);
        setMonthWheelPosition(targetIndex, true);
      });

      monthWheelContainer.addEventListener('wheel', (e) => {
        e.preventDefault();
        let newIndex = tempSelectedMonth + (e.deltaY > 0 ? 1 : -1);
        setMonthWheelPosition(newIndex, true);
      }, { passive: false });

      // ═══════════════════════════════
      // データ読み込み・保存（Firebase）
      // ═══════════════════════════════
      async function loadData() {
        try {
          const snapshot = await logsRef.once('value');
          const data = snapshot.val();
          if (data) {
            logData = data;
          }
        } catch (e) {
          console.error('Firebaseからの読み込みに失敗:', e);
        }
        
        renderCalendar();
        
        // 今日の日付を選択
        const today = new Date();
        selectDate(today.getFullYear(), today.getMonth(), today.getDate(), false);
      }

      async function saveData() {
        try {
          await logsRef.set(logData);
          console.log('Firebaseに保存完了');
        } catch (e) {
          console.error('Firebaseへの保存に失敗:', e);
          alert('保存に失敗しました。ネットワーク接続を確認してください。');
        }
      }

      // ═══════════════════════════════
      // 編集機能
      // ═══════════════════════════════
      function addLog(dateKey, text) {
        if (!text.trim()) return;
        
        if (!logData[dateKey]) {
          logData[dateKey] = [];
        }
        logData[dateKey].push(text.trim());
        saveData();
        
        const [year, month, day] = dateKey.split('-').map(Number);
        renderCalendar();
        renderLog(year, month - 1, day);
      }

      function deleteLog(dateKey, index) {
        if (!logData[dateKey]) return;
        
        logData[dateKey].splice(index, 1);
        if (logData[dateKey].length === 0) {
          delete logData[dateKey];
        }
        saveData();
        
        const [year, month, day] = dateKey.split('-').map(Number);
        renderCalendar();
        renderLog(year, month - 1, day);
      }

      if (isEditMode) {
        document.body.classList.add('edit-mode');
        
        addBtn.addEventListener('click', () => {
          if (selectedDate) {
            addLog(selectedDate, editInput.value);
            editInput.value = '';
          }
        });

        editInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && selectedDate) {
            addLog(selectedDate, editInput.value);
            editInput.value = '';
          }
        });
      }

      // ═══════════════════════════════
      // 初期化
      // ═══════════════════════════════
      function init() {
        initYearWheel();
        initMonthWheel();
        updateHeader();
        loadData();
      }

      init();
    });
  </script>
</body>
</html>
